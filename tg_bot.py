import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from tg_bot_config import BOT_TOKEN

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è FSM
storage = MemoryStorage()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(storage=storage)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è FSM
class SellerState(StatesGroup):
    waiting_for_api = State()  # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è API –∫–ª—é—á–∞

# –•—Ä–∞–Ω–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ –ë–î)
user_data = {}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    welcome_text = """
ü§ñ *–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Wildberries*

–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å:
‚Ä¢ üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø—Ä–æ–¥–∞–∂
‚Ä¢ üîÆ –ü—Ä–æ–≥–Ω–æ–∑–∞–º–∏ —Å–ø—Ä–æ—Å–∞
‚Ä¢ üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ üß† AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

*–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã:*
1. –î–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á –æ—Ç –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ - /add_api
2. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/add_api - –¥–æ–±–∞–≤–∏—Ç—å API –∫–ª—é—á –º–∞–≥–∞–∑–∏–Ω–∞
/analytics - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
/forecast - –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –ø–µ—Ä–∏–æ–¥
/products - –∞–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤
/settings - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

*–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º?* üöÄ
"""
    await message.answer(welcome_text, parse_mode="Markdown")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /add_api
@dp.message(Command("add_api"))
async def cmd_add_api(message: types.Message, state: FSMContext):
    help_text = """
üìù *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞ Wildberries*

*–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á:*
1. –ó–∞–π–¥–∏—Ç–µ –≤ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Wildberries
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª *"–ü—Ä–æ—Ñ–∏–ª—å"* ‚Üí *"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞"*
3. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π API –∫–ª—é—á
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –º–Ω–µ

*–ß—Ç–æ —è –º–æ–≥—É –¥–µ–ª–∞—Ç—å —Å API:*
‚Ä¢ –ü–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞–∫–∞–∑–∞–º
‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∏
‚Ä¢ –°—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã —Å–ø—Ä–æ—Å–∞
‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ü–µ–Ω—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤

‚ö†Ô∏è *–í–∞—à API –∫–ª—é—á –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º.*

*–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à API –∫–ª—é—á:* (–∏–ª–∏ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã)
"""
    await message.answer(help_text, parse_mode="Markdown")
    await state.set_state(SellerState.waiting_for_api)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è API –∫–ª—é—á–∞
@dp.message(SellerState.waiting_for_api)
async def process_api_key(message: types.Message, state: FSMContext):
    api_key = message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫–æ–º–∞–Ω–¥–∞ –ª–∏ —ç—Ç–æ
    if api_key.startswith('/'):
        await message.answer("–ü—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è API –∫–ª—é—á–∞ –ø—Ä–µ—Ä–≤–∞–Ω.")
        await state.clear()
        return
    
    # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è API –∫–ª—é—á–∞ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
    if len(api_key) < 20:
        await message.answer("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º API –∫–ª—é—á (–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ —Å–ª–æ–≤–∞—Ä—å, –ø–æ—Ç–æ–º –Ω—É–∂–Ω–æ –≤ –ë–î)
    user_id = message.from_user.id
    user_data[user_id] = {"api_key": api_key}
    
    await message.answer(f"""
‚úÖ *API –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!*

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
/analytics - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
/forecast - –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø—Ä–æ—Å–∞
/products - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤

*–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:*
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö - /sync_data
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É - /analytics
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã - /settings

–í–∞—à –∫–ª—é—á: `{api_key[:15]}...` (—Å–∫—Ä—ã—Ç–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
""", parse_mode="Markdown")
    
    await state.clear()

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–æ–¥–∞
@dp.message(Command("cancel"))
async def cmd_cancel(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    if current_state is None:
        return
    
    await state.clear()
    await message.answer("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

# –ö–æ–º–∞–Ω–¥–∞ /analytics (–∑–∞–≥–ª—É—à–∫–∞)
@dp.message(Command("analytics"))
async def cmd_analytics(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_data or "api_key" not in user_data[user_id]:
        await message.answer("""
‚ö†Ô∏è *–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á!*

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /add_api –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –æ—Ç –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ Wildberries.

–ë–µ–∑ API –∫–ª—é—á–∞ —è –Ω–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.
""", parse_mode="Markdown")
        return
    
    await message.answer("""
üìä *–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂*

*–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:*
‚Ä¢ –ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–¥–∞–∂ –ø–æ –¥–Ω—è–º/–Ω–µ–¥–µ–ª—è–º
‚Ä¢ –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Å–∏—è –∏ —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫
‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏

*–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥–µ—Ç:*
/analytics_sales - –ø—Ä–æ–¥–∞–∂–∏
/analytics_stocks - –æ—Å—Ç–∞—Ç–∫–∏
/analytics_prices - —Ü–µ–Ω—ã
/analytics_competitors - –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã

*–ê –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:*
/add_api - –µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –∫–ª—é—á
/sync_data - –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
""", parse_mode="Markdown")

# –ö–æ–º–∞–Ω–¥–∞ /sync_data (–∑–∞–≥–ª—É—à–∫–∞)
@dp.message(Command("sync_data"))
async def cmd_sync_data(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_data or "api_key" not in user_data[user_id]:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ API –∫–ª—é—á —á–µ—Ä–µ–∑ /add_api")
        return
    
    await message.answer("""
üîÑ *–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö*

*–°—Ç–∞—Ç—É—Å:* –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

*–ß—Ç–æ –±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è:*
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π)
‚Ä¢ –¢–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–∞—Ö
‚Ä¢ –û—Ç–∑—ã–≤—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏

*–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:* —Ä–∞–∑ –≤ 4 —á–∞—Å–∞

*–î–ª—è —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏:*
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –∫–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –≤ /settings
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–µ—Ä–≤–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

*–û–∂–∏–¥–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞!*
""", parse_mode="Markdown")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ—Å—Ç–∞ (–ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
@dp.message()
async def echo(message: types.Message):
    await message.answer("""
ü§ñ *–ù–µ –ø–æ–Ω–∏–º–∞—é –∫–æ–º–∞–Ω–¥—É*

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/add_api - –¥–æ–±–∞–≤–∏—Ç—å API –∫–ª—é—á –º–∞–≥–∞–∑–∏–Ω–∞
/analytics - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
/sync_data - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
/settings - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
/cancel - –æ—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è

–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ üëÜ
""", parse_mode="Markdown")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    logging.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())